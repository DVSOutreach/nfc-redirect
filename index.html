<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Redirecting...</title>
    <script>
      // Where the user ends up no matter what
      const redirectUrl =
        "https://caplanc.org/access-resources/safety-empowerment/domestic-violence-services/";

      // PRIMARY endpoint (older flow that most tags are already pointing to)
      const primaryFlowUrl =
        "https://default1155ce382a364ffaad4da283064efb.68.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9bcd0e64bcfe47b182626f09806cb9b0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=dsDZvg20sa-nyx0f571DfnXfEXlMkM6_he0cqU2aUCk";

      // EXPANDED endpoint (CAP v.3)
      const expandedFlowUrl =
        "https://default1155ce382a364ffaad4da283064efb.68.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/89285acbed1a4b878841eb1c13414230/triggers/manual/paths/invoke?api-version=1";

      (function () {
        const urlParams = new URLSearchParams(window.location.search);

        function getParam(keys, fallback = "") {
          for (const k of keys) {
            const v = urlParams.get(k);
            if (v !== null && v !== "") return v;
          }
          return fallback;
        }

        function nowUtcIso() {
          return new Date().toISOString();
        }

        // Core fields (legacy)
        const Tagname = getParam(["Tagname", "tagname", "tag"], "");
        const CurrentTime = getParam(["CurrentTime", "currentTime", "time"], nowUtcIso());
        const Department = getParam(["Department", "department", "dept"], "");
        const Location = getParam(["Location", "location", "loc"], "");

        // Expanded fields (new naming + backwards compatibility)
        const Initials = getParam(
          ["Initials", "initials", "ProviderInitials", "providerInitials"],
          ""
        );

        const InitialsCapturedUTC = getParam(
          ["InitialsCapturedUTC", "initialsCapturedUTC", "ProviderInitialsCapturedUTC"],
          nowUtcIso()
        );

        // Payload for PRIMARY (keep it minimal so older flow never chokes)
        const legacyData = {
          Tagname,
          CurrentTime,
          Department,
          Location
        };

        // Payload for EXPANDED (full payload)
        const expandedData = {
          Tagname,
          CurrentTime,
          Department,
          Location,
          Initials,
          InitialsCapturedUTC,
          PageUrl: window.location.href,
          Path: window.location.pathname,
          UserAgent: navigator.userAgent
        };

        function post(url, data) {
          return fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
            keepalive: true
          });
        }

        // Fire-and-forget to BOTH endpoints; redirect regardless
        try { post(primaryFlowUrl, legacyData).catch(() => {}); } catch (e) {}
        try { post(expandedFlowUrl, expandedData).catch(() => {}); } catch (e) {}

        // Redirect (small delay so POST has a head start)
        setTimeout(() => window.location.replace(redirectUrl), 150);
      })();
    </script>
  </head>
  <body>
    Redirecting...
  </body>
</html>
