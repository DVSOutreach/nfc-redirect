<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Redirecting...</title>
    <script>
      // Where the user ends up no matter what
      const redirectUrl =
        "https://caplanc.org/access-resources/safety-empowerment/domestic-violence-services/";

      // PRIMARY endpoint (older flow that most tags are already pointing to)
      const primaryFlowUrl =
        "https://default1155ce382a364ffaad4da283064efb.68.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9bcd0e64bcfe47b182626f09806cb9b0/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=dsDZvg20sa-nyx0f571DfnXfEXlMkM6_he0cqU2aUCk";

      // EXPANDED endpoint (CAP v.3 - SIGNED "anyone can trigger" URL)
      const expandedFlowUrl =
        "https://default1155ce382a364ffaad4da283064efb.68.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/89285acbed1a4b878841eb1c13414230/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=BrJvpHWGnE3h3_nLagPxuxcI4uKCL_Q_VkRaI9XaAIE";

      // Give the POSTs time to finish
      const MAX_WAIT_MS = 2000;

      (function () {
        const url = new URL(window.location.href);
        const sp = url.searchParams;

        function nowUtcIso() {
          return new Date().toISOString();
        }

        function getParam(keys, fallback = "") {
          for (const k of keys) {
            const v = sp.get(k);
            if (v !== null && v !== "") return v;
          }
          return fallback;
        }

        // Core fields (legacy)
        const Tagname = getParam(["Tagname", "tagname", "tag"], "");
        const CurrentTime = getParam(["CurrentTime", "currentTime", "time"], nowUtcIso());
        const Department = getParam(["Department", "department", "dept"], "");
        const Location = getParam(["Location", "location", "loc"], "");

        // Initials (read from URL first)
        let Initials = getParam(
          ["Initials", "initials", "ProviderInitials", "providerInitials"],
          ""
        );

        let InitialsCapturedUTC = getParam(
          ["InitialsCapturedUTC", "initialsCapturedUTC", "ProviderInitialsCapturedUTC"],
          ""
        );

        // PROMPT if missing initials
        if (!Initials) {
          while (true) {
            const entered = window.prompt("Enter your initials (2–4 letters):", "");
            if (entered === null) break; // user cancelled; proceed without initials

            const cleaned = entered.trim().toUpperCase();
            if (/^[A-Z]{2,4}$/.test(cleaned)) {
              Initials = cleaned;
              InitialsCapturedUTC = nowUtcIso();
              break;
            }

            alert("Please enter 2–4 letters only (example: AA).");
          }
        }

        // If initials exist but captured time missing, stamp it
        if (Initials && !InitialsCapturedUTC) {
          InitialsCapturedUTC = nowUtcIso();
        }

        // WRITE initials into the current URL so PageUrl stored in SharePoint includes them
        if (Initials) sp.set("Initials", Initials);
        if (InitialsCapturedUTC) sp.set("InitialsCapturedUTC", InitialsCapturedUTC);
        window.history.replaceState(null, "", url.toString());

        // Payload for PRIMARY (minimal)
        const legacyData = { Tagname, CurrentTime, Department, Location };

        // Payload for EXPANDED (full)
        const expandedData = {
          Tagname,
          CurrentTime,
          Department,
          Location,
          Initials,
          InitialsCapturedUTC,
          PageUrl: url.toString(),
          Path: window.location.pathname,
          UserAgent: navigator.userAgent
        };

        function post(url, data) {
          return fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
            keepalive: true
          });
        }

        const posts = [
          post(primaryFlowUrl, legacyData).catch(() => {}),
          post(expandedFlowUrl, expandedData).catch(() => {})
        ];

        const timeout = new Promise((resolve) => setTimeout(resolve, MAX_WAIT_MS));

        Promise.race([Promise.allSettled(posts), timeout]).finally(() => {
          window.location.replace(redirectUrl);
        });
      })();
    </script>
  </head>
  <body>
    Redirecting...
  </body>
</html>
