<!doctype html>
<meta charset="utf-8">
<title>Redirecting...</title>

<script>
  // Power Apps PLAY base (unchanged)
  const base =
    "https://apps.powerapps.com/play/e/default-1155ce38-2a36-4ffa-ad4d-a283064efb68/a/16521173-a066-4b39-ba98-c528d19a6b6b?tenantId=1155ce38-2a36-4ffa-ad4d-a283064efb68";

  // CAP v.3 (signed)
  const flowUrl =
    "https://default1155ce382a364ffaad4da283064efb.68.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/89285acbed1a4b878841eb1c13414230/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=BrJvpHWGnE3h3_nLagPxuxcI4uKCL_Q_VkRaI9XaAIE";

  const url = new URL(window.location.href);
  const p = url.searchParams;

  const bin = (p.get("bin") || "").trim();
  const c   = (p.get("c")   || "").trim();

  function nowUtcIso() {
    return new Date().toISOString();
  }

  function getParam(keys, fallback = "") {
    for (const k of keys) {
      const v = p.get(k);
      if (v !== null && v !== "") return v;
    }
    return fallback;
  }

  const Tagname = getParam(["Tagname", "tagname", "tag"], "");
  const Department = getParam(["Department", "department", "dept"], "");
  const Location = getParam(["Location", "location", "loc"], "");
  const CurrentTime = getParam(["CurrentTime", "currentTime", "time"], nowUtcIso());

  let Initials = getParam(
    ["Initials", "initials", "ProviderInitials", "providerInitials"],
    ""
  );

  let InitialsCapturedUTC = getParam(
    ["InitialsCapturedUTC", "initialsCapturedUTC", "ProviderInitialsCapturedUTC"],
    ""
  );

  // PROMPT if missing initials
  if (!Initials) {
    while (true) {
      const entered = window.prompt("Enter your initials (2–4 letters):", "");
      if (entered === null) break;

      const cleaned = entered.trim().toUpperCase();
      if (/^[A-Z]{2,4}$/.test(cleaned)) {
        Initials = cleaned;
        InitialsCapturedUTC = nowUtcIso();
        break;
      }

      alert("Please enter 2–4 letters only (example: AA).");
    }
  }

  if (Initials && !InitialsCapturedUTC) {
    InitialsCapturedUTC = nowUtcIso();
  }

  // Write back into URL so PageUrl contains initials
  if (Initials) p.set("Initials", Initials);
  if (InitialsCapturedUTC) p.set("InitialsCapturedUTC", InitialsCapturedUTC);
  window.history.replaceState(null, "", url.toString());

  // Original destination logic
  const dest = c
    ? `${base}&c=${encodeURIComponent(c)}&m=edit`
    : `${base}&bin=${encodeURIComponent(bin)}&m=edit`;

  if (!bin && !c) {
    document.write("Missing bin or code. Use ?bin=CD1 or ?c=ABC123");
  } else {
    const payload = {
      Bin: bin,
      Code: c,
      Tagname: Tagname,
      CurrentTime: CurrentTime,
      Department: Department,
      Location: Location,
      Initials: Initials,
      InitialsCapturedUTC: InitialsCapturedUTC,
      PageUrl: url.toString()
    };

    try {
      fetch(flowUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        keepalive: true
      }).catch(() => {});
    } catch (e) {}

    setTimeout(() => location.replace(dest), 300);
  }
</script>

Redirecting...

Redirecting...
